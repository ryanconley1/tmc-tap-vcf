#@ load("@ytt:data", "data")


fullName:
  name: #@ data.values.tap.name
meta:
  generation: "1"
spec:
  clusterPackageData:
  - clusterFullName:
      managementClusterName: #@ data.values.clusters.view.mgmt_cluster
      name: #@ data.values.clusters.view.name
      provisionerName: #@ data.values.clusters.view.provisioner
      orgId: #@ data.values.orgId
    inlineValues:
      package_overlays:
      - name: contour
        secrets:
          - name: envoy-lb-class
      excluded_packages:
      - fluxcd.source.controller.tanzu.vmware.com
      appliveview:
        ingressEnabled: true
      ceip_policy_disclosed: true
      deployed_through_tmc: true
      metadata_store:
        ingress_issuer: tap-ingress-selfsigned
        ns_for_export_app_cert: '*'
      profile: view
      shared:
        ingress_domain: #@ data.values.tap.profiles.view.ingress_domain + "." + data.values.base_domain
        ingress_issuer: #@ data.values.tap.profiles.view.ingress_issuer
      contour:
        envoy:
          service:
            annotations:
              external-dns.alpha.kubernetes.io/hostname: #@  "wildcard." + data.values.tap.profiles.view.ingress_domain + "." + data.values.base_domain

      tap_gui:
        app_config:
          auth:
            allowGuestAccess: true
      tap_telemetry:
        customer_entitlement_account_number: ""
    packageRef:
      packageMetadataName: tap.tanzu.vmware.com
      versionSelection:
        constraints: #@ data.values.tap.version
    tapProfile: view
  - clusterFullName:
      managementClusterName: #@ data.values.clusters.build.mgmt_cluster
      name: #@ data.values.clusters.build.name
      provisionerName: #@ data.values.clusters.build.provisioner
      orgId: #@ data.values.orgId
    clusterUrl: #@ data.values.tap.profiles.build.clusterUrl
    clusterCaCert: #@ data.values.tap.profiles.build.clusterCA
    inlineValues:
      ceip_policy_disclosed: true
      deployed_through_tmc: true
      excluded_packages:
      - fluxcd.source.controller.tanzu.vmware.com
      grype:
        metadataStore:
          authSecret:
            importFromNamespace: metadata-store-secrets
            name: store-auth-token
          caSecret:
            importFromNamespace: metadata-store-secrets
            name: store-ca-cert
          url: #@ "https://metadata-store." + data.values.tap.profiles.view.ingress_domain + "." + data.values.base_domain
      namespace_provisioner:
        additional_sources:
        - git:
            ref: origin/main
            subPath: #@ "ns-provisioner/clusters/"+ data.values.clusters.build.name + "/config"
            url: #@ data.values.gitrepo
          path: _ytt_lib/testing-scanning-supplychain-parameterized-setup
        controller: false
        default_parameters:
          supply_chain_service_account:
            secrets:
            - github-secret
        gitops_install:
          ref: origin/main
          subPath: #@ "ns-provisioner/clusters/"+ data.values.clusters.build.name + "/namespaces"
          url: #@ data.values.gitrepo
      supply_chain: "testing_scanning"
      ootb_supply_chain_testing_scanning:
        gitops:
          commit_strategy: pull_request
          pull_request:
            commit_branch: ""
            pull_request_body: generated by supply chain
            pull_request_title: ready for review
            server_kind: github
          repository_name: #@ data.values.gitrepo_name
          repository_owner: #@ data.values.gitrepo_owner
          server_address: https://github.com/
          ssh_secret: github-secret
        shared:
          image_registry:
           project_path: #@ data.values.tap.profiles.build.registry.server + "/" + data.values.tap.profiles.build.registry.project
           secret:
            name: tap-vcf-registry-creds
            namespace: tap-install 
      profile: build
    packageRef:
      packageMetadataName: tap.tanzu.vmware.com
      versionSelection:
        constraints: #@ data.values.tap.version
    tapProfile: build  
  - clusterFullName:
      managementClusterName: #@ data.values.clusters.run.mgmt_cluster
      name: #@ data.values.clusters.run.name
      provisionerName: #@ data.values.clusters.run.provisioner
      orgId: #@ data.values.orgId
    clusterUrl: #@ data.values.tap.profiles.run.clusterUrl
    clusterCaCert: #@ data.values.tap.profiles.run.clusterCA
    inlineValues:
      ceip_policy_disclosed: true
      deployed_through_tmc: true
      excluded_packages:
      - fluxcd.source.controller.tanzu.vmware.com
      namespace_provisioner:
        additional_sources:
        - git:
            ref: origin/main
            subPath: #@ "ns-provisioner/clusters/"+ data.values.clusters.run.name + "/config"
            url: #@ data.values.gitrepo
        controller: false
        default_parameters:
          supply_chain_service_account:
            secrets:
            - github-secret
        gitops_install:
          ref: origin/main
          subPath: #@ "ns-provisioner/clusters/"+ data.values.clusters.run.name + "/namespaces"
          url: #@ data.values.gitrepo
      package_overlays:
      - name: contour
        secrets:
          - name: envoy-lb-class
      profile: run
      shared:
        ingress_domain: #@ data.values.tap.profiles.run.ingress_domain + "." +data.values.base_domain
        ingress_issuer: #@ data.values.tap.profiles.run.ingress_issuer
      contour:
        envoy:
          service:
            annotations:
              external-dns.alpha.kubernetes.io/hostname: #@  "wildcard." + data.values.tap.profiles.run.ingress_domain + "." + data.values.base_domain
      tap_telemetry:
        customer_entitlement_account_number: ""
    packageRef:
      packageMetadataName: tap.tanzu.vmware.com
      versionSelection:
        constraints: #@ data.values.tap.version
    tapProfile: run  
type:
  kind: Solution
  package: vmware.tanzu.manage.v1alpha1.tanzupackage.tap.solution
  version: v1alpha1

