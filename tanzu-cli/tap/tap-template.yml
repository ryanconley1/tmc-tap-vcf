#@ load("@ytt:data", "data")
#@ load("@ytt:base64", "base64")


fullName:
  name: #@ data.values.tap.name
meta:
  generation: "1"
spec:
  clusterPackageData:
  - clusterFullName:
      managementClusterName: #@ data.values.clusters.view.mgmt_cluster
      name: #@ data.values.clusters.view.name
      provisionerName: #@ data.values.clusters.view.provisioner
      orgId: #@ data.values.orgId
    inlineValues:
      package_overlays:
      - name: contour
        secrets:
          - name: envoy-lb-class
      excluded_packages:
      - fluxcd.source.controller.tanzu.vmware.com
      appliveview:
        ingressEnabled: true
      ceip_policy_disclosed: true
      deployed_through_tmc: true
      metadata_store:
        ns_for_export_app_cert: '*'
      profile: view
      shared:
        ingress_domain: #@ data.values.tap.profiles.view.ingress_domain + "." + data.values.base_domain
        ingress_issuer: #@ data.values.tap.profiles.view.ingress_issuer
      contour:
        envoy:
          service:
            annotations:
              external-dns.alpha.kubernetes.io/hostname: #@  "wildcard." + data.values.tap.profiles.view.ingress_domain + "." + data.values.base_domain

      tap_gui:
        app_config:
          auth:
            allowGuestAccess: true
      tap_telemetry:
        customer_entitlement_account_number: ""
    packageRef:
      packageMetadataName: tap.tanzu.vmware.com
      versionSelection:
        constraints: #@ data.values.tap.version
    tapProfile: view
  - clusterFullName:
      managementClusterName: #@ data.values.clusters.build.mgmt_cluster
      name: #@ data.values.clusters.build.name
      provisionerName: #@ data.values.clusters.build.provisioner
      orgId: #@ data.values.orgId
    clusterUrl: #@ data.values.tap.profiles.build.clusterUrl
    clusterCaCert: #@ data.values.tap.profiles.build.clusterCA
    inlineValues:
      amr:
        observer:
          auth:
            kubernetes_service_accounts:
              enable: true
          cloudevent_handler:
            endpoint: #@ "https://amr-cloudevent-handler." + data.values.tap.profiles.view.ingress_domain + "." + data.values.base_domain
      ceip_policy_disclosed: true
      deployed_through_tmc: true
      excluded_packages:
      - fluxcd.source.controller.tanzu.vmware.com
      namespace_provisioner:
        additional_sources:
        - git:
            ref: origin/main
            subPath: #@ "ns-provisioner/clusters/"+ data.values.clusters.build.name + "/config"
            url: #@ data.values.gitrepo
          path: _ytt_lib/testing-scanning-supplychain-parameterized-setup
        controller: false
        default_parameters:
          supply_chain_service_account:
            secrets:
            - github-secret
        gitops_install:
          ref: origin/main
          subPath: #@ "ns-provisioner/clusters/"+ data.values.clusters.build.name + "/namespaces"
          url: #@ data.values.gitrepo
      supply_chain: "testing_scanning"
      ootb_supply_chain_testing_scanning:
        carvel_package:
          workflow_enabled: true
          gitops_subpath: flux/apps/base/packages
          openapiv3_enabled: true
        image_scanner_template_name: image-vulnerability-scan-trivy
        image_scanning_cli:
          image: registry.tanzu.vmware.com/vmware-tap-packages/tap-packages@sha256:31d36a8582a75b042dc12aea0808f822e27747a2f8103af0f0c52ef8d68a8bf0
        supported_workloads:
        - type: web
          cluster_config_template_name: config-template
        - type: server
          cluster_config_template_name: server-template
        - type: worker
          cluster_config_template_name: worker-template
        - type: avi-web
          cluster_config_template_name: avi-web-template

        gitops:
          commit_strategy: pull_request
          pull_request:
            commit_branch: ""
            pull_request_body: generated by supply chain
            pull_request_title: ready for review
            server_kind: github
          repository_name: #@ data.values.gitrepo_name
          repository_owner: #@ data.values.gitrepo_owner
          server_address: https://github.com/
          credentials_secret: github-secret
      shared:
        ca_cert_data: #@ data.read("certs/root_ca.crt")
        image_registry:
          project_path: #@ data.values.tap.profiles.build.registry.server + "/" + data.values.tap.profiles.build.registry.project
          secret:
            name: tap-vcf-registry-creds
            namespace: tap-install 
      profile: build
    packageRef:
      packageMetadataName: tap.tanzu.vmware.com
      versionSelection:
        constraints: #@ data.values.tap.version
    tapProfile: build  
  - clusterFullName:
      managementClusterName: #@ data.values.clusters.run.mgmt_cluster
      name: #@ data.values.clusters.run.name
      provisionerName: #@ data.values.clusters.run.provisioner
      orgId: #@ data.values.orgId
    clusterUrl: #@ data.values.tap.profiles.run.clusterUrl
    clusterCaCert: #@ data.values.tap.profiles.run.clusterCA
    inlineValues:
      ceip_policy_disclosed: true
      deployed_through_tmc: true
      excluded_packages:
      - fluxcd.source.controller.tanzu.vmware.com
      namespace_provisioner:
        additional_sources:
        - git:
            ref: origin/main
            subPath: #@ "ns-provisioner/clusters/"+ data.values.clusters.run.name + "/config"
            url: #@ data.values.gitrepo
        controller: false
        default_parameters:
          supply_chain_service_account:
            secrets:
            - github-secret
        gitops_install:
          ref: origin/main
          subPath: #@ "ns-provisioner/clusters/"+ data.values.clusters.run.name + "/namespaces"
          url: #@ data.values.gitrepo
      package_overlays:
      - name: contour
        secrets:
          - name: envoy-lb-class
      profile: run
      shared:
        ingress_domain: #@ data.values.tap.profiles.run.ingress_domain + "." +data.values.base_domain
        ingress_issuer: #@ data.values.tap.profiles.run.ingress_issuer
      contour:
        envoy:
          service:
            annotations:
              external-dns.alpha.kubernetes.io/hostname: #@  "wildcard." + data.values.tap.profiles.run.ingress_domain + "." + data.values.base_domain
      tap_telemetry:
        customer_entitlement_account_number: ""
    packageRef:
      packageMetadataName: tap.tanzu.vmware.com
      versionSelection:
        constraints: #@ data.values.tap.version
    tapProfile: run  
type:
  kind: Solution
  package: vmware.tanzu.manage.v1alpha1.tanzupackage.tap.solution
  version: v1alpha1

